# IMPORTANT: This snippet modifies the existing MCP gateway configuration
# The auth gateway will handle /mcp and forward to the internal MCP gateway

# First, update the existing mcp component trigger to use a private route:
# Change:
#   [[trigger.http]]
#   route = "/mcp"
#   component = "mcp"
# To:
#   [[trigger.http]]
#   route = { private = true }
#   component = "ftl-mcp-gateway"

# Auth Gateway Configuration
# By default, authentication is disabled. To enable authentication, override 
# the auth_config variable when running the application.
[variables]
auth_config = { default = '''
{
  "mcp_gateway_url": "http://ftl-mcp-gateway.spin.internal/mcp-internal",
  "trace_id_header": "X-Trace-Id",
  "enabled": false,
  "providers": []
}
''' }

# Auth Gateway - handles authentication and OAuth discovery
[[trigger.http]]
route = "/mcp"
component = "mcp"

[[trigger.http]]
route = "/.well-known/oauth-protected-resource"
component = "mcp"

[[trigger.http]]
route = "/.well-known/oauth-authorization-server"
component = "mcp"

[component.mcp]
source = { registry = "ghcr.io", package = "fastertools:ftl-auth-gateway", version = "0.0.4" }
allowed_outbound_hosts = ["http://*.spin.internal", "https://*.authkit.app"]
[component.mcp.variables]
auth_config = "{% raw %}{{ auth_config }}{% endraw %}"

# MCP Gateway - internal endpoint (protected by auth gateway)
[[trigger.http]]
route = { private = true }
component = "ftl-mcp-gateway"

[component.ftl-mcp-gateway]
source = { registry = "ghcr.io", package = "fastertools:ftl-mcp-gateway", version = "0.0.3" }
allowed_outbound_hosts = ["http://*.spin.internal"]
[component.ftl-mcp-gateway.variables]
tool_components = "{% raw %}{{ tool_components }}{% endraw %}"
validate_arguments = "true"